name: Release Helm Charts

on:
  push:
    branches: [master]
    paths:
      - 'sources/**'
  pull_request:
    branches: [master]
    paths:
      - 'sources/**'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Setup yq
        uses: mikefarah/yq@master

      - name: Get changed charts
        id: changed-charts
        run: |
          changed=$(git diff --name-only HEAD~1 HEAD | grep '^sources/' | cut -d'/' -f2 | sort -u)
          if [ -n "$changed" ]; then
            echo "changed_charts<<EOF" >> $GITHUB_OUTPUT
            echo "$changed" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Lint and Package Charts
        if: steps.changed-charts.outputs.changed_charts
        run: |
          mkdir -p temp-packages
          
          for chart in ${{ steps.changed-charts.outputs.changed_charts }}; do
            if [ -f "sources/$chart/Chart.yaml" ]; then
              echo "Processing chart: $chart"
              cd sources/$chart
              
              # Lint chart
              helm lint .
              
              # Update dependencies if needed
              if grep -q "dependencies:" Chart.yaml; then
                echo "Updating dependencies for $chart"
                helm dependency update
              fi
              
              # Get version
              version=$(yq '.version' Chart.yaml)
              echo "Chart $chart version: $version"
              
              cd ../../
              
              # Package chart
              helm package sources/$chart -d temp-packages/
              
              echo "Packaged $chart-$version.tgz"
            fi
          done

      - name: Update Repository Index
        if: steps.changed-charts.outputs.changed_charts
        run: |
          # Copy existing packages to temp
          cp docs/*.tgz temp-packages/ 2>/dev/null || true
          
          # Generate new index
          helm repo index temp-packages --url https://luna-sites.github.io/luna-helm-charts/
          
          # Move everything to docs
          cp temp-packages/* docs/
          
          # Clean up
          rm -rf temp-packages

      - name: Commit and Push Changes
        if: steps.changed-charts.outputs.changed_charts
        run: |
          git add docs/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          charts="${{ steps.changed-charts.outputs.changed_charts }}"
          chart_list=$(echo "$charts" | tr '\n' ', ' | sed 's/,$//')
          
          git commit -m "Release charts: $chart_list

          ðŸ¤– Auto-generated by GitHub Actions
          
          Updated charts:
          $(echo "$charts" | sed 's/^/- /')"
          
          git push

      - name: Deploy to GitHub Pages
        if: steps.changed-charts.outputs.changed_charts
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          cname: luna-sites.github.io